
= Playbooks
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[NOTE.speaker]
--
OK avec les commandes ad-hoc, on a fait des actions très pratique sur les machines, en parallèle,
Mais on exécute qu'une commande à la fois, pas de variabilisation, pas d'orchestration.
--

== Ok can we code now ?
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[%step]
* Language Ansible pour la configuration, l'orchestration et le déploiement
* Programmation déclarative
* Yaml !
* On fait quoi sur quelles machines ?

[NOTE.speaker]
--
* Language Ansible pour la configuration, l'orchestration et le déploiement
* Programmation déclarative
* Yaml !
* On fait quoi sur quelles machines ?
--

== Playbooks
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source]
----
- hosts: webservers
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root
  tasks:
  - name: ensure apache is at the latest version
    yum: name=httpd state=latest
  - name: write the apache config file
    template: src=/srv/httpd.j2 dest=/etc/httpd.conf
    notify:
    - restart apache
  - name: ensure apache is running (and enable it at boot)
    service: name=httpd state=started enabled=yes
  handlers:
    - name: restart apache
      service: name=httpd state=restarted
----

[NOTE.speaker]
--
* On installe la dernière version du package httpd
* On va copier le template du fichier de conf httpd.conf
** On notifie le handler qu'il est nécessaire de redémarrer httpd
* On active le service httpd et on démarre si ça n'est pas déjà fait
* Si nécessaire on redémarre le service
--

== Playbooks | Exécution
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

ansible-playbook playbook.yml

== Variables
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source,yaml]
.vars/main.yml
----
httpd_version: 2.3
----

[source,yaml]
.tasks/main.yml
----
- name: Ensure httpd is installed
  yum: name= "httpd"
            state= present
            version= {{ httpd_version }}
----

[NOTE.speaker]
--
* Exemple simple
* Mais les variables vont nous servir à bien plus de choses, on va voir ça juste après.
--

== Organisation du répertoire playbooks
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source]
----
playbooks/
├── hosts
├── groups_vars
│   ├── all
│   │   └── vars.yml
│   ├── prod
│   │   └── vars.yml
│   ├── dev
│   │   └── vars.yml
│   └── qualif
│       └── vars.yml
├── host_vars
│   ├── webserver01
│   │   └── vars.yml
│   └── database02
│       └── vars.yml
├── site.yml
├── webservers.yml
└── database.yml
----

== Condition
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

Utilise des variables ou des facts (setup)

[source,yaml]
.Pour exécuter un module
----
- name: Install Apache (Ubuntu)
  apt: name=apache state=latest
  when: ansible_os_family == 'Debian'

- name: Install Apache (CentOS)
  yum: name=httpd state=latest
  when: ansible_os_family == 'RedHat'
----

== Condition (2)
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source,yaml]
.Pour faire un "include"
----
- include: tasks/sometasks.yml
  when: "'reticulating splines' in output"
----

== Boucle
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source,yaml]
----
- name: add several users
  user:
    name: "{{ item }}"
    state: present
    groups: "wheel"
  with_items:
     - testuser1
     - testuser2
----

== Boucle avec des objets
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source,yaml]
----
- name: add several users
  user:
    name: "{{ item.name }}"
    state: present
    groups: "{{ item.groups }}"
  with_items:
    - { name: 'testuser1', groups: 'wheel' }
    - { name: 'testuser2', groups: 'root' }
----

== Templates (Jinja2)
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source]
----
# Generated by Ansible for {{ansible_fqdn}}
{% if step_main_version == 'v7' %}
export JDK_HOME={{ jdk_home }}
export JAVA_HOME={{ jdk_home }}
{% endif %}
{% if step_jmx_enabled %}
export JAVA_OPTS="{{ java_opts }} {{ step_jmx_options }}"
{% else %}
export JAVA_OPTS="{{ java_opts }}"
{% endif %}
----

== Rolling Updates
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source,yaml]
----
- name: test play
  hosts: webservers
  serial:
    - "10%"
    - "20%"
  max_fail_percentage: 5
----

== Delegation
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source,yaml]
----
- hosts: webservers
  serial: 5
  tasks:
  - name: take out of load balancer pool
    command: /usr/bin/take_out_of_pool {{ inventory_hostname }}
    delegate_to: {{loadbalancer}}
----

[source,yaml]
----
# ...
  tasks:
  - name: take out of load balancer pool
    local_action: command /usr/bin/take_out_of_pool {{ inventory_hostname }}
----

== Playbook | Problèmes
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[%step]
* Très pratique mais...
* Manque de généricité
* Difficilement réutilisable

[NOTE.speaker]
--
* Très pratique mais...
* Manque de généricité
* Difficilement réutilisable
--

== Roles
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[%step]
* Organiser son playbook
* Basé sur des conventions (tasks, handlers, vars …)
* Réutilisable !!
* Un role => un groupe de machine
** Ex: rôle « apache_httpd » => serveurs « front »

[NOTE.speaker]
--
* Organiser son playbook
* Basé sur des conventions (tasks, handlers, vars …)
* Réutilisable !!
* Un role => un groupe de machine
** Ex: rôle « apache_httpd » => serveurs « front »
--

== Roles | Organisation
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source]
----
playbooks/
├── hosts
├── group_vars
├── roles
│   ├── ansible_role_httpd
│   │   ├── defaults
│   │   │   └── main.yml
│   │   ├── files
│   │   │   └── <file.txt>
│   │   ├── handlers
│   │   │   └── main.yml
│   │   ├── templates
│   │   │   └── <httpd.nj2>
│   │   ├── tasks
│   │   │   └── main.yml
│   │   └── vars
│   │       └── main.yml
│   └── ansible_role_mysql
│   │   ├── defaults
│   │   │   └── main.yml
│   │   ├── files
│   │   │   └── <file.txt>
│   │   ├── handlers
│   │   │   └── main.yml
│   │   ├── templates
│   │   │   └── <mysql.conf.nj2>
│   │   ├── tasks
│   │   │   └── main.yml
│   │   └── vars
│   │       └── main.yml
└── site.yml
----

== Roles | Organisation
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[%step]
* *tasks* : Contient les modules à exécuter (point d'entrée du rôle)
* *handlers* : Contient les modules à "notifier" (en cas de changement)
* *vars* : Contient les variables (RedHat / Ubuntu par exemple)
* *defaults* : Les variables par défaut
* *templates* : Les fichiers à templatiser
* *files* : Les fichiers statiques
* *meta* : Contient les dépendances du rôle

== Roles | Playbook
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

[source,yaml]
----
- name: Install httpd on webservers
  hosts: webservers
  roles:
    - ansible-role-apache
----

== Ansible-galaxy
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

image::{imagedir}/ansible-galaxy-home.png[]

== Ansible-galaxy (2)
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

Ansible galaxy est le site pour trouver, réutiliser ou partager des rôles Ansible.

https://galaxy.ansible.com/

== Ansible | Jenkins
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

* Déclencher un build à partir d’un événement (appel rest, poll scm)
* Lancer un playbook à partir d’une UI
* Historiser les exécutions
* Intégrer un déploiement Ansible dans un pipeline Jenkins

== Jenkins | Configuration d'un job
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]

image::{imagedir}/jenkins-deploy-ansible-config.png[]

== Jenkins | Console
image::{imagedir}/sfeir_fond_big.jpg[background, size=cover]
s
image::{imagedir}/jenkins-deploy-ansible-console.png[]
